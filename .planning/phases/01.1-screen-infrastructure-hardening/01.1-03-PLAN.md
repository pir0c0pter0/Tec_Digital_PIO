---
phase: 01.1-screen-infrastructure-hardening
plan: 03
type: execute
wave: 3
depends_on: ["01.1-02"]
files_modified:
  - include/button_manager.h
  - src/button_manager.cpp
  - include/jornada_keyboard.h
  - src/jornada_keyboard.cpp
  - include/numpad_example.h
  - src/numpad_example.cpp
autonomous: true

must_haves:
  truths:
    - "ButtonManager does not create an internal StatusBar (no duplicate status bar)"
    - "Old ScreenManager class in jornada_keyboard.h is removed"
    - "Legacy extern C helpers (initScreenManager, showNumpadKeyboard, showJornadaKeyboard, toggleKeyboard) are removed"
    - "Legacy helper functions (showNumpad, hideNumpad, createDefaultJornadaButtons, initButtonManager) are removed"
    - "Build passes with zero warnings related to screen code"
  artifacts:
    - path: "include/jornada_keyboard.h"
      provides: "Clean header without old ScreenManager class or extern C wrappers"
    - path: "src/button_manager.cpp"
      provides: "createScreen() without internal statusBar creation"
    - path: "include/button_manager.h"
      provides: "No statusBar/statusIgnicao/statusTempoIgnicao/statusTempoJornada/statusMensagem members"
    - path: "include/numpad_example.h"
      provides: "No showNumpad/hideNumpad helper declarations"
  key_links:
    - from: "ButtonManager::createScreen()"
      to: "gridContainer creation only"
      via: "no internal statusBar block"
      pattern: "gridContainer"
    - from: "jornada_keyboard.h"
      to: "JornadaKeyboard class only"
      via: "old ScreenManager class removed"
---

<objective>
Remove dead code: internal StatusBar from ButtonManager, old ScreenManager class, and legacy helper functions.

Purpose: The internal StatusBar in ButtonManager (v1.x legacy) duplicates the persistent StatusBar on lv_layer_top() causing visual overlap and wasted resources. The old ScreenManager class in jornada_keyboard.h is dead code replaced by ScreenManagerImpl. Legacy extern C helpers and global functions are no longer called. Removing all of this reduces code size, eliminates confusion, and prevents accidental use of deprecated APIs.

Output: Clean ButtonManager without internal status bar, clean jornada_keyboard.h without old ScreenManager, no legacy helper functions.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-screen-infrastructure-hardening/01.1-RESEARCH.md
@.planning/phases/01.1-screen-infrastructure-hardening/01.1-02-SUMMARY.md
@include/button_manager.h
@src/button_manager.cpp
@include/jornada_keyboard.h
@src/jornada_keyboard.cpp
@include/numpad_example.h
@src/numpad_example.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove internal StatusBar from ButtonManager + remove legacy status methods</name>
  <files>include/button_manager.h, src/button_manager.cpp</files>
  <action>
  Remove the ButtonManager internal status bar that duplicates the persistent StatusBar on lv_layer_top().

  **Step 1: Remove internal StatusBar LVGL objects from header (button_manager.h):**
  Remove these private member declarations:
  - `lv_obj_t* statusBar;` (the internal one -- NOT the class StatusBar)
  - `lv_obj_t* statusIgnicao;`
  - `lv_obj_t* statusTempoIgnicao;`
  - `lv_obj_t* statusTempoJornada;`
  - `lv_obj_t* statusMensagem;`
  - `lv_timer_t* statusUpdateTimer;` (if it only served the internal status bar)
  - `MessageConfig currentMessageConfig;` struct and member
  - `unsigned long messageExpireTime;`

  Remove these public method declarations:
  - `void updateStatusBar(const BtnStatusBarData& data);`
  - `void setStatusMessage(const char* message);` (both overloads)
  - `void clearStatusMessage();`
  - `void setDefaultMessageTimeout(uint32_t timeoutMs);`
  - `void startStatusTimer(int intervalMs);`
  - `void stopStatusTimer();`

  Remove the static callback declarations:
  - `static void statusUpdateCallback(lv_timer_t* timer);` (if it only served the internal status bar)
  - `static void statusTimerHandler(lv_timer_t* timer);` (if it only served the internal status bar)

  Remove the `BtnStatusBarData` struct definition (it is only used by the removed `updateStatusBar`).

  Keep the `ButtonManager::getScreen()` method and all button/popup related members.

  **Step 2: Remove internal StatusBar creation from createScreen() (button_manager.cpp):**
  In `ButtonManager::createScreen()` (~lines 155-200), remove the block that creates:
  - The statusBar lv_obj (40px-tall bar)
  - statusIgnicao label
  - statusTempoIgnicao label
  - statusTempoJornada label
  - statusMensagem label
  - statusUpdateCallback timer

  Keep the screen creation (`lv_obj_create(NULL)`) and gridContainer creation. Adjust gridContainer height if it was previously `GRID_AREA_HEIGHT` (which already accounts for STATUS_BAR_HEIGHT).

  **Important consideration for gridContainer sizing:** The persistent StatusBar on lv_layer_top() is 40px at the TOP of the screen. The ButtonManager screen occupies the FULL 480x320 area, but the top 40px is visually occluded by the StatusBar overlay. The gridContainer should start at y=STATUS_BAR_HEIGHT (40px) and have height GRID_AREA_HEIGHT (280px). Verify the current code already does this -- if the internal statusBar was at the bottom, the gridContainer sizing may be different. Adjust to account for the persistent StatusBar at the top.

  **Step 3: Remove method implementations (button_manager.cpp):**
  Remove the implementations of:
  - `updateStatusBar()`
  - `setStatusMessage()` (both overloads)
  - `clearStatusMessage()`
  - `setDefaultMessageTimeout()`
  - `startStatusTimer()` / `stopStatusTimer()`
  - `statusUpdateCallback()`
  - `statusTimerHandler()`

  **Step 4: Remove legacy helper functions (button_manager.h and button_manager.cpp):**
  Remove from header declarations:
  - `void initButtonManager();`
  - `void updateBtnManagerButtons(bool ignicaoOn);`
  - `void updateBtnManagerStatus();`
  - `void updateBtnManagerStatusBar();`
  - `void createDefaultJornadaButtons();`

  Remove their implementations from button_manager.cpp (they use `getInstance()` and the internal status bar).

  Keep `const char* formatTime(unsigned long timeMs);` and `lv_color_t getStateColor(int state);` if they are used by other code (JornadaKeyboard uses getStateColor).

  **Step 5: Update constructor initialization (button_manager.cpp):**
  Remove initialization of removed members (statusBar = nullptr, statusIgnicao = nullptr, etc.).

  **Step 6: Update destructor (button_manager.cpp):**
  Remove deletion of statusUpdateTimer and statusTimer if they were removed. The destructor was rewritten in Plan 01 -- verify it doesn't reference removed members.

  Language: Comments in Portuguese (BR).
  </action>
  <verify>
  Run `pio run` -- build must pass. Grep for `statusIgnicao` in button_manager.h and button_manager.cpp -- zero matches. Grep for `updateStatusBar` in button_manager.h -- zero matches. Grep for `initButtonManager` in button_manager.h -- zero matches.
  </verify>
  <done>
  ButtonManager no longer creates internal StatusBar. All legacy status methods removed. Legacy helper functions removed. gridContainer properly sized for persistent StatusBar at top. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove old ScreenManager class + extern C helpers + legacy dead code</name>
  <files>include/jornada_keyboard.h, src/jornada_keyboard.cpp, include/numpad_example.h, src/numpad_example.cpp</files>
  <action>
  Remove dead code from jornada_keyboard and numpad_example that is no longer used.

  **Step 1: Remove old ScreenManager class from jornada_keyboard.h:**
  Delete the entire `class ScreenManager { ... };` block (lines ~119-157 of the original header). This is the OLD ScreenManager (with TelaAtiva enum, container, numpadInstance, jornadaInstance, btnScreenSwitch), replaced by `ScreenManagerImpl` in `ui/screen_manager.h`.

  Delete the extern C block (lines ~163-189):
  - `void initScreenManager();`
  - `void showNumpadKeyboard();`
  - `void showJornadaKeyboard();`
  - `void toggleKeyboard();`

  **Step 2: Remove old ScreenManager implementation from jornada_keyboard.cpp:**
  Delete the entire ScreenManager implementation section (~lines 832-1067 based on research). This includes:
  - `ScreenManager* ScreenManager::instance = nullptr;`
  - `ScreenManager::ScreenManager()` constructor
  - `ScreenManager::~ScreenManager()` destructor
  - `ScreenManager::getInstance()`
  - `ScreenManager::init()`
  - `ScreenManager::showNumpadScreen()`
  - `ScreenManager::showJornadaScreen()`
  - `ScreenManager::toggleScreen()`
  - `ScreenManager::createScreenSwitchButton()`
  - `onScreenSwitchClick()` callback
  - `initScreenManager()` extern C function
  - `showNumpadKeyboard()` extern C function
  - `showJornadaKeyboard()` extern C function
  - `toggleKeyboard()` extern C function

  **Step 3: Remove JornadaKeyboard legacy init() no-args (jornada_keyboard.cpp):**
  The `JornadaKeyboard::init()` (no arguments, ~line 106) calls `ButtonManager::getInstance()`. This is dead code in the new architecture where `init(ButtonManager* mgr)` is always used. Remove the no-args `init()` method.
  Also remove the declaration from the header: `void init();` (keep only `void init(ButtonManager* mgr);`).

  **Step 4: Clean up JornadaKeyboard static instance (jornada_keyboard.cpp):**
  Remove `JornadaKeyboard* JornadaKeyboard::instance = nullptr;` static member definition.
  Remove the `getInstance()` method implementation.
  Remove `static JornadaKeyboard* instance;` from the header.
  Remove `static JornadaKeyboard* getInstance();` from the header.
  Make the constructor public (it already is) -- no changes needed there.

  **Step 5: Remove NumpadExample legacy code (numpad_example.h, numpad_example.cpp):**
  Remove from header:
  - `static NumpadExample* instance;`
  - `static NumpadExample* getInstance();`
  - `void init();` (no-args overload -- keep `void init(ButtonManager* mgr);`)
  - Declaration of `void showNumpad();` and `void hideNumpad();` global helpers

  Remove from .cpp:
  - `NumpadExample* NumpadExample::instance = nullptr;` static definition
  - `NumpadExample::getInstance()` implementation
  - `NumpadExample::init()` no-args implementation
  - `void showNumpad()` global helper
  - `void hideNumpad()` global helper
  - `void numpadInit()` extern C function (if it exists)

  **Step 6: Remove static callback functions that are now dead code:**
  After Plan 02 converted callbacks to lambdas, the original static callback functions may be dead code:
  - `JornadaKeyboard::onActionButtonClick(int buttonId)` -- if fully replaced by lambda in createKeyboard(), remove it
  - `NumpadExample::onDigitClick(int buttonId)` -- if fully replaced by lambda, remove it
  - `NumpadExample::onOkClick(int buttonId)` -- same
  - `NumpadExample::onCancelClick(int buttonId)` -- same

  Only remove if no other code calls them. Verify with grep before removing each.

  Keep `JornadaKeyboard::onMotoristaSelectClick` and `JornadaKeyboard::onCancelPopupClick` as they are LVGL event callbacks (static) that were refactored to use user_data in Plan 02.

  Language: Comments in Portuguese (BR).
  </action>
  <verify>
  Run `pio run` -- build must pass with zero errors. Verify removals:
  - `grep -n "class ScreenManager" include/jornada_keyboard.h` -- zero matches (old class removed)
  - `grep -n "initScreenManager\|showNumpadKeyboard\|showJornadaKeyboard\|toggleKeyboard" include/jornada_keyboard.h` -- zero matches
  - `grep -n "g_numpadInstance" src/numpad_example.cpp` -- zero matches
  - `grep -n "getInstance" include/jornada_keyboard.h include/numpad_example.h` -- zero matches
  - `grep -n "showNumpad\|hideNumpad" include/numpad_example.h` -- zero matches
  Check no other file references removed functions: `grep -rn "initScreenManager\|showNumpadKeyboard\|showJornadaKeyboard\|toggleKeyboard\|showNumpad\|hideNumpad\|initButtonManager\|createDefaultJornadaButtons" src/ include/` -- should have zero matches (or only in comments).
  </verify>
  <done>
  Old ScreenManager class removed from jornada_keyboard.h/.cpp. All extern C helpers removed. getInstance() removed from JornadaKeyboard and NumpadExample. Legacy no-args init() removed. showNumpad/hideNumpad removed. Dead static callbacks removed. Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `pio run` passes with zero errors
2. No duplicate StatusBar on screen (internal one removed)
3. `grep -rn "class ScreenManager" include/jornada_keyboard.h` -- zero matches
4. `grep -rn "getInstance" include/jornada_keyboard.h include/numpad_example.h include/button_manager.h` -- only in button_manager.h (kept for compatibility, or zero if also removed)
5. `grep -rn "statusIgnicao\|statusTempoIgnicao\|statusTempoJornada\|statusMensagem" include/button_manager.h` -- zero matches
6. `grep -rn "initScreenManager\|showNumpadKeyboard\|showJornadaKeyboard\|toggleKeyboard" src/ include/` -- zero matches
7. `grep -rn "showNumpad\|hideNumpad" include/numpad_example.h` -- zero matches
8. `grep -rn "initButtonManager\|createDefaultJornadaButtons" include/button_manager.h` -- zero matches
</verification>

<success_criteria>
- ButtonManager::createScreen() does not create internal status bar
- Old ScreenManager class completely removed from jornada_keyboard.h and .cpp
- All legacy extern C helpers removed
- getInstance() removed from JornadaKeyboard and NumpadExample
- No-args init() removed from both classes
- showNumpad/hideNumpad/numpadInit removed from NumpadExample
- initButtonManager/createDefaultJornadaButtons/updateBtnManager* removed from ButtonManager
- Build passes with zero errors
- No build warnings related to unused variables or functions in screen code
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-screen-infrastructure-hardening/01.1-03-SUMMARY.md`
</output>
