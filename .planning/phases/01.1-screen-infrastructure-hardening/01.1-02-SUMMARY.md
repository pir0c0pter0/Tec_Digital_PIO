---
phase: 01.1-screen-infrastructure-hardening
plan: 02
subsystem: ui
tags: [lvgl, singleton, per-screen, lambda, callbacks, embedded, screen-isolation]

# Dependency graph
requires:
  - phase: 01.1-screen-infrastructure-hardening
    plan: 01
    provides: "ButtonManager with hardened event handlers (no singleton fallback)"
provides:
  - "JornadaKeyboard per-screen instances via new JornadaKeyboard()"
  - "NumpadExample per-screen instances via new NumpadExample()"
  - "Lambda-based callbacks without getInstance() for button actions"
  - "lv_obj user_data pattern for LVGL event callbacks (motorista/cancel)"
  - "Timer user_data pattern for timeout timer (NumpadExample)"
  - "StatusBar wiring via screen setStatusBar() methods"
  - "g_numpadInstance global eliminated"
affects: [01.1-03, 02-ble-core]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Lambda capture of self pointer for std::function callbacks (ButtonBatchDef)"
    - "lv_obj_set_user_data(obj, this) + lv_obj_get_user_data(target) for LVGL event resolution"
    - "lv_timer_create(cb, interval, this) for per-instance timer callbacks"
    - "Screen::setStatusBar() delegates to domain logic object"
    - "Domain object deleted BEFORE ButtonManager in screen destructor (dependency order)"

key-files:
  created: []
  modified:
    - include/jornada_keyboard.h
    - src/jornada_keyboard.cpp
    - include/ui/screens/jornada_screen.h
    - src/ui/screens/jornada_screen.cpp
    - include/numpad_example.h
    - src/numpad_example.cpp
    - include/ui/screens/numpad_screen.h
    - src/ui/screens/numpad_screen.cpp
    - src/main.cpp

key-decisions:
  - "Keep static callbacks and getInstance() as deprecated for backward compatibility with legacy ScreenManager code (Plan 03 will remove)"
  - "Use lv_obj_set_user_data for LVGL event callbacks (motorista/cancel) since they require C function pointers, not std::function"
  - "Use lambda capture for ButtonBatchDef callbacks since they accept std::function<void(int)>"
  - "Delete domain logic object before ButtonManager in destroy() to respect dependency order"

patterns-established:
  - "Per-screen instance: Screen::create() uses new DomainClass() instead of DomainClass::getInstance()"
  - "Lambda self capture: JornadaKeyboard* self = this; def.callback = [self](int id) {...}"
  - "LVGL user_data resolution: lv_obj_set_user_data(btn, this) + static_cast in callback"
  - "StatusBar delegation: Screen::setStatusBar(bar) -> domainObj_->setStatusBar(bar)"

# Metrics
duration: 6min
completed: 2026-02-10
---

# Phase 01.1 Plan 02: Domain Logic Singleton Elimination Summary

**JornadaKeyboard and NumpadExample converted to per-screen instances with lambda callbacks, lv_obj user_data resolution, and g_numpadInstance global removed**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-10T14:08:24Z
- **Completed:** 2026-02-10T14:14:42Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- JornadaKeyboard created with `new` in JornadaScreen::create(), action button callbacks use lambda with captured self pointer, motorista/cancel popup callbacks resolve instance via lv_obj_get_user_data()
- NumpadExample created with `new` in NumpadScreen::create(), digit/ok/cancel callbacks use lambda with captured self pointer, timeout timer passes `this` as user_data instead of global
- g_numpadInstance global eliminated entirely -- timer callback uses timer->user_data
- processarAcao and createKeyboard in JornadaKeyboard use statusBar_->setMessage() instead of btnManager->setStatusMessage()
- main.cpp passes StatusBar via numpadScreen.setStatusBar() and jornadaScreen.setStatusBar() instead of NumpadExample::getInstance()->setStatusBar()

## Task Commits

Each task was committed atomically:

1. **Task 1: Convert JornadaKeyboard from singleton to per-screen instance with lambda callbacks** - `1f40614` (feat)
2. **Task 2: Convert NumpadExample from singleton to per-screen instance + fix timeout timer + update main.cpp** - `8d7a673` (feat)

## Files Created/Modified
- `include/jornada_keyboard.h` - Added StatusBar* member, setStatusBar(), deprecation comments on singleton
- `src/jornada_keyboard.cpp` - Lambda callbacks in createKeyboard(), user_data in popup callbacks, statusBar_ for messages
- `include/ui/screens/jornada_screen.h` - Added setStatusBar() public method, StatusBar forward declaration
- `src/ui/screens/jornada_screen.cpp` - new JornadaKeyboard() instead of getInstance(), delete in destroy(), setStatusBar delegation
- `include/numpad_example.h` - Deprecation comments on singleton and static callbacks
- `src/numpad_example.cpp` - Removed g_numpadInstance, lambda callbacks, timer with this, deprecated functions marked
- `include/ui/screens/numpad_screen.h` - Added setStatusBar() public method, StatusBar forward declaration
- `src/ui/screens/numpad_screen.cpp` - new NumpadExample() instead of getInstance(), delete in destroy(), setStatusBar delegation
- `src/main.cpp` - Replaced singleton StatusBar wiring with screen method calls, removed numpad_example.h include

## Decisions Made
- Keep static callbacks and getInstance() as deprecated for backward compatibility with legacy ScreenManager code in jornada_keyboard.cpp (will be removed in Plan 03 when legacy code is cleaned up)
- Use lv_obj_set_user_data for LVGL event callbacks (motorista/cancel buttons) because they require C-compatible function pointers, not std::function -- the user_data pattern is the standard LVGL approach
- Use lambda capture for ButtonBatchDef callbacks because they accept std::function<void(int)> which supports lambdas with captures
- Delete domain logic object before ButtonManager in screen destructor to respect dependency ordering (domain objects reference ButtonManager objects)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Both domain logic classes are per-screen instances, ready for Plan 03 (cleanup of legacy singleton code)
- All screens have setStatusBar() method for StatusBar integration
- Destruction order is safe: domain object -> ButtonManager -> screen
- No blockers for subsequent plans

## Self-Check: PASSED

- FOUND: include/jornada_keyboard.h
- FOUND: src/jornada_keyboard.cpp
- FOUND: include/ui/screens/jornada_screen.h
- FOUND: src/ui/screens/jornada_screen.cpp
- FOUND: include/numpad_example.h
- FOUND: src/numpad_example.cpp
- FOUND: include/ui/screens/numpad_screen.h
- FOUND: src/ui/screens/numpad_screen.cpp
- FOUND: src/main.cpp
- FOUND: 01.1-02-SUMMARY.md
- FOUND: commit 1f40614
- FOUND: commit 8d7a673

---
*Phase: 01.1-screen-infrastructure-hardening*
*Completed: 2026-02-10*
