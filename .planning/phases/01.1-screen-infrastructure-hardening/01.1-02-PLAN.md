---
phase: 01.1-screen-infrastructure-hardening
plan: 02
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - include/jornada_keyboard.h
  - src/jornada_keyboard.cpp
  - include/numpad_example.h
  - src/numpad_example.cpp
  - include/ui/screens/jornada_screen.h
  - src/ui/screens/jornada_screen.cpp
  - include/ui/screens/numpad_screen.h
  - src/ui/screens/numpad_screen.cpp
  - src/main.cpp
autonomous: true

must_haves:
  truths:
    - "JornadaKeyboard and NumpadExample are per-screen instances (not singletons)"
    - "Creating two JornadaScreens works without shared state conflict"
    - "Static callbacks in JornadaKeyboard resolve instance via lambda capture or user_data, not getInstance()"
    - "NumpadExample timeout timer uses this pointer via lv_timer user_data, not g_numpadInstance global"
    - "main.cpp passes StatusBar to screens instead of using NumpadExample::getInstance()"
    - "All v1.x functionality preserved"
  artifacts:
    - path: "src/ui/screens/jornada_screen.cpp"
      provides: "Per-screen JornadaKeyboard via new JornadaKeyboard()"
      contains: "new JornadaKeyboard()"
    - path: "src/ui/screens/numpad_screen.cpp"
      provides: "Per-screen NumpadExample via new NumpadExample()"
      contains: "new NumpadExample()"
    - path: "src/jornada_keyboard.cpp"
      provides: "Lambda-based callbacks without getInstance()"
    - path: "src/numpad_example.cpp"
      provides: "Timer with this pointer, no g_numpadInstance global"
    - path: "src/main.cpp"
      provides: "StatusBar passed via screen methods, not singleton access"
  key_links:
    - from: "JornadaScreen::create()"
      to: "new JornadaKeyboard()"
      via: "per-screen instance creation"
      pattern: "new JornadaKeyboard\\(\\)"
    - from: "NumpadScreen::create()"
      to: "new NumpadExample()"
      via: "per-screen instance creation"
      pattern: "new NumpadExample\\(\\)"
    - from: "JornadaKeyboard::createKeyboard()"
      to: "lambda callback capturing this"
      via: "std::function with captured self pointer"
      pattern: "\\[self\\]"
    - from: "NumpadExample::startTimeoutTimer()"
      to: "lv_timer_create(timeoutTimerCallback, 1000, this)"
      via: "this pointer as timer user_data"
      pattern: "lv_timer_create.*this"
    - from: "JornadaScreen"
      to: "StatusBar"
      via: "setStatusBar() method"
      pattern: "setStatusBar"
---

<objective>
Convert JornadaKeyboard and NumpadExample from singletons to per-screen instances with proper callback resolution.

Purpose: The singleton pattern means all screens share a single JornadaKeyboard/NumpadExample instance, so calling `init(btnManager)` overwrites the previous screen's ButtonManager pointer. Converting to per-screen instances achieves true isolation -- each screen owns its own domain logic object with its own ButtonManager reference.

Output: JornadaKeyboard and NumpadExample are created with `new` in their respective screens, all static callbacks use lambda captures or lv_obj user_data instead of getInstance(), and the g_numpadInstance global is eliminated.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-screen-infrastructure-hardening/01.1-RESEARCH.md
@.planning/phases/01.1-screen-infrastructure-hardening/01.1-01-SUMMARY.md
@include/jornada_keyboard.h
@src/jornada_keyboard.cpp
@include/numpad_example.h
@src/numpad_example.cpp
@src/ui/screens/jornada_screen.cpp
@src/ui/screens/numpad_screen.cpp
@src/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert JornadaKeyboard from singleton to per-screen instance with lambda callbacks</name>
  <files>include/jornada_keyboard.h, src/jornada_keyboard.cpp, include/ui/screens/jornada_screen.h, src/ui/screens/jornada_screen.cpp</files>
  <action>
  Convert JornadaKeyboard from singleton pattern to per-screen instance. This is the most complex change in Phase 1.1 because three static callbacks must be rewired.

  **Step 1: JornadaKeyboard header (jornada_keyboard.h):**
  - Keep `static JornadaKeyboard* instance;` and `static JornadaKeyboard* getInstance();` for backward compatibility (they will be removed in Plan 03), but add a deprecation comment: `// DEPRECATED: usar instancias per-screen via new JornadaKeyboard()`
  - Add `StatusBar* statusBar_;` private member (for status messages, matching NumpadExample pattern).
  - Add `void setStatusBar(StatusBar* bar);` public method.
  - Add forward declaration `class StatusBar;` near the top if not already present.
  - Keep `onActionButtonClick`, `onMotoristaSelectClick`, `onCancelPopupClick` as static methods in the header (they remain static because LVGL requires C-compatible function pointers for event callbacks). The implementation will change to resolve instance from user_data.

  **Step 2: JornadaKeyboard::createKeyboard() callback refactoring (jornada_keyboard.cpp):**

  For the 12 action button callbacks, the current code uses a `static void onActionButtonClick(int buttonId)` as the `def.callback`. This is a `std::function<void(int)>` so it supports lambda captures.

  Replace:
  ```cpp
  def.callback = onActionButtonClick;  // static, uses getInstance()
  ```
  With:
  ```cpp
  JornadaKeyboard* self = this;
  def.callback = [self](int buttonId) {
      // Encontra qual acao foi clicada
      for (int i = 0; i < ACAO_MAX; i++) {
          if (self->botoes[i].buttonId == buttonId) {
              playAudioFile(AUDIO_FILE_CLICK);
              self->showMotoristaSelection(self->botoes[i].tipo);
              break;
          }
      }
  };
  ```

  The lambda captures `self` (the JornadaKeyboard instance). This replaces the static `onActionButtonClick` function. Look at the existing `onActionButtonClick` implementation (~line 788) to ensure the lambda does the same thing -- find the button by ID, play audio, show motorista selection. Copy the exact logic.

  **Step 3: showMotoristaSelection() popup callbacks (jornada_keyboard.cpp):**

  For `onMotoristaSelectClick` and `onCancelPopupClick`, these are raw LVGL event callbacks (not std::function). They must resolve JornadaKeyboard* from LVGL user_data.

  In `showMotoristaSelection()`:
  - When creating motorista buttons: store `this` as user_data on each button via `lv_obj_set_user_data(btnMotorista, this)`. Note: the `lv_event_get_user_data(e)` currently passes the motorista index. We need both. Use `lv_obj_set_user_data()` for the JornadaKeyboard pointer, and keep `lv_event_get_user_data(e)` for the motorista index.
  - In `onMotoristaSelectClick`: retrieve JornadaKeyboard* via `lv_obj_get_user_data(lv_event_get_target(e))`, and motorista index via `lv_event_get_user_data(e)`. If JornadaKeyboard* is null, log error and return.
  - For cancel button: same pattern -- `lv_obj_set_user_data(btnCancel, this)` in showMotoristaSelection, then retrieve in `onCancelPopupClick`.

  **Step 4: Remove getInstance() calls from static callbacks (jornada_keyboard.cpp):**
  - `onActionButtonClick` (~line 788): This function is no longer needed if the lambda replaces it. Keep the function definition but mark it deprecated with a comment. Or remove it entirely if no other code calls it.
  - `onMotoristaSelectClick` (~line 812): Replace `JornadaKeyboard* jornada = getInstance();` with `JornadaKeyboard* jornada = static_cast<JornadaKeyboard*>(lv_obj_get_user_data(lv_event_get_target(e)));` + null guard.
  - `onCancelPopupClick` (~line 820): Same pattern.

  **Step 5: Update processarAcao for StatusBar (jornada_keyboard.cpp):**
  - Where `processarAcao` calls `btnManager->setStatusMessage(...)`, replace with: `if (statusBar_) { statusBar_->setMessage(...); }` -- check the StatusBar API for the correct method name. If StatusBar does not have a `setMessage` method, keep `btnManager->setStatusMessage()` for now (it will be addressed in Plan 03).
  - Initialize `statusBar_ = nullptr` in the constructor.

  **Step 6: JornadaScreen updates (jornada_screen.h, jornada_screen.cpp):**
  - Change `jornada_screen.cpp:57` from `jornadaKb_ = JornadaKeyboard::getInstance();` to `jornadaKb_ = new JornadaKeyboard();`
  - Add `void setStatusBar(StatusBar* bar);` to JornadaScreen public interface in the header.
  - Implement: `void JornadaScreen::setStatusBar(StatusBar* bar) { if (jornadaKb_) jornadaKb_->setStatusBar(bar); }`
  - In JornadaScreen::destroy(): add `delete jornadaKb_; jornadaKb_ = nullptr;` BEFORE deleting btnManager_ (JornadaKeyboard may reference ButtonManager objects, clean it up first).

  Language: Comments in Portuguese (BR). Use ESP_LOGE/ESP_LOGI as used in existing code.
  </action>
  <verify>
  Run `pio run` -- build must pass. Grep for `JornadaKeyboard::getInstance()` in jornada_screen.cpp -- zero matches. Grep for `new JornadaKeyboard()` in jornada_screen.cpp -- exactly one match. Grep for `getInstance()` in onMotoristaSelectClick and onCancelPopupClick -- zero matches.
  </verify>
  <done>
  JornadaKeyboard created with `new` in JornadaScreen::create(). All three static callbacks resolve instance via lambda capture (action buttons) or lv_obj user_data (popup buttons). JornadaScreen has setStatusBar() method. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert NumpadExample from singleton to per-screen instance + fix timeout timer + update main.cpp</name>
  <files>include/numpad_example.h, src/numpad_example.cpp, include/ui/screens/numpad_screen.h, src/ui/screens/numpad_screen.cpp, src/main.cpp</files>
  <action>
  Convert NumpadExample from singleton to per-screen instance and update main.cpp StatusBar wiring.

  **Step 1: NumpadExample header (numpad_example.h):**
  - Keep `static NumpadExample* instance;` and `static NumpadExample* getInstance();` with deprecation comment (will be removed in Plan 03).
  - No new members needed (NumpadExample already has `StatusBar* statusBar_` and `setStatusBar()`).

  **Step 2: Remove g_numpadInstance global (numpad_example.cpp):**
  - Find and remove `static NumpadExample* g_numpadInstance = nullptr;` (~line 35).
  - Remove all assignments to it (likely in constructor or init).

  **Step 3: Fix timeout timer to use this pointer (numpad_example.cpp):**
  - In `startTimeoutTimer()`: change `lv_timer_create(timeoutTimerCallback, 1000, NULL)` to `lv_timer_create(timeoutTimerCallback, 1000, this)`.
  - In `timeoutTimerCallback(lv_timer_t* timer)`: replace `NumpadExample* numpad = g_numpadInstance;` (or similar) with `NumpadExample* numpad = static_cast<NumpadExample*>(timer->user_data);`. Add null guard.

  **Step 4: Convert static callbacks to use lambda captures (numpad_example.cpp):**

  NumpadExample has three static callbacks: `onDigitClick`, `onOkClick`, `onCancelClick`. These are `std::function<void(int)>` callbacks passed to ButtonManager, so lambdas with captures work.

  In `createNumpad()`, for digit buttons replace:
  ```cpp
  def.callback = onDigitClick;  // static, uses getInstance()
  ```
  With:
  ```cpp
  NumpadExample* self = this;
  def.callback = [self](int buttonId) {
      // Copy logic from existing onDigitClick, using self-> instead of getInstance()->
  };
  ```

  Same for OK button (`onOkClick`) and Cancel button (`onCancelClick`). For each:
  1. Look at the existing static function body
  2. Copy its logic into a lambda that captures `self`
  3. Replace `getInstance()->` with `self->`
  4. Keep the static function definition but mark deprecated (or remove if no external callers)

  **Step 5: NumpadScreen updates (numpad_screen.h, numpad_screen.cpp):**
  - Change `numpad_screen.cpp:57` from `numpad_ = NumpadExample::getInstance();` to `numpad_ = new NumpadExample();`
  - Add `void setStatusBar(StatusBar* bar);` to NumpadScreen public interface.
  - Implement: `void NumpadScreen::setStatusBar(StatusBar* bar) { if (numpad_) numpad_->setStatusBar(bar); }`
  - In NumpadScreen::destroy(): add `delete numpad_; numpad_ = nullptr;` BEFORE deleting btnManager_.

  **Step 6: Update main.cpp StatusBar wiring:**
  - Replace line 167 `NumpadExample::getInstance()->setStatusBar(&statusBar);` with `numpadScreen.setStatusBar(&statusBar);`
  - Add `jornadaScreen.setStatusBar(&statusBar);` right after (JornadaKeyboard now also has setStatusBar).
  - No other changes to main.cpp needed.

  **Step 7: Remove dead helper functions (numpad_example.cpp):**
  - The functions `showNumpad()` and `hideNumpad()` at the bottom of numpad_example.cpp use `getInstance()`. Mark them deprecated with comments for now (Plan 03 will remove them entirely). Do NOT remove them in this task to minimize risk.

  Language: Comments in Portuguese (BR).
  </action>
  <verify>
  Run `pio run` -- build must pass. Grep for `NumpadExample::getInstance()` in numpad_screen.cpp and main.cpp -- zero matches. Grep for `g_numpadInstance` in numpad_example.cpp -- zero matches. Grep for `new NumpadExample()` in numpad_screen.cpp -- exactly one match.
  </verify>
  <done>
  NumpadExample created with `new` in NumpadScreen::create(). Timeout timer uses `this` via lv_timer user_data. g_numpadInstance global removed. Static callbacks use lambda captures. main.cpp passes StatusBar via screen methods, not singleton. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pio run` passes with zero errors
2. `grep -rn "JornadaKeyboard::getInstance()" src/ui/screens/` -- zero matches
3. `grep -rn "NumpadExample::getInstance()" src/ui/screens/ src/main.cpp` -- zero matches
4. `grep -rn "g_numpadInstance" src/numpad_example.cpp` -- zero matches
5. `grep -rn "new JornadaKeyboard()" src/ui/screens/jornada_screen.cpp` -- one match
6. `grep -rn "new NumpadExample()" src/ui/screens/numpad_screen.cpp` -- one match
7. `grep -rn "setStatusBar" src/main.cpp` -- matches for both jornadaScreen and numpadScreen
</verification>

<success_criteria>
- JornadaKeyboard and NumpadExample are per-screen instances created with `new` in their respective screen classes
- All static callbacks in both classes resolve instance via lambda capture or user_data, not getInstance()
- g_numpadInstance global is eliminated
- Timeout timer uses this pointer as user_data
- main.cpp passes StatusBar to screens via setStatusBar() methods
- Build passes with zero errors
- All existing v1.x functionality preserved (buttons, popups, audio, numpad input, timeout)
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-screen-infrastructure-hardening/01.1-02-SUMMARY.md`
</output>
