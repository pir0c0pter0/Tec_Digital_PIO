---
phase: 01.1-screen-infrastructure-hardening
plan: 03
subsystem: ui
tags: [lvgl, screen-manager, dead-code-removal, embedded, esp32]

# Dependency graph
requires:
  - phase: 01.1-02
    provides: "Per-screen domain logic instances with lambda callbacks and lv_obj user_data pattern"
provides:
  - "Clean ButtonManager without internal StatusBar (no duplicate status bar)"
  - "Clean jornada_keyboard.h without old ScreenManager class"
  - "No legacy extern C helpers or global singleton fallbacks"
  - "gridContainer positioned for persistent StatusBar at top"
affects: [01.1-screen-infrastructure-hardening, 02-ble-core, 03-settings]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "gridContainer at y=STATUS_BAR_HEIGHT under persistent StatusBar on lv_layer_top()"
    - "createPopupOverlay respects persistent StatusBar position"

key-files:
  created: []
  modified:
    - include/button_manager.h
    - src/button_manager.cpp
    - include/jornada_keyboard.h
    - src/jornada_keyboard.cpp
    - include/numpad_example.h
    - src/numpad_example.cpp

key-decisions:
  - "Removed BtnStatusBarData struct entirely (only consumer was removed updateStatusBar)"
  - "Removed extern C wrappers (buttonManagerInit/GetInstance/UpdateStatusBar) -- only used in main_old.cpp.bak"
  - "gridContainer repositioned from y=0 to y=STATUS_BAR_HEIGHT for persistent StatusBar at top"
  - "createPopupOverlay updated to y=STATUS_BAR_HEIGHT alignment for consistency"
  - "Removed commented-out METODO 2 references left as harmless comments"

patterns-established:
  - "No internal status bar in ButtonManager -- use persistent StatusBar on lv_layer_top() exclusively"
  - "No singleton getInstance() on domain classes -- use per-screen instances via init(ButtonManager*)"

# Metrics
duration: 6min
completed: 2026-02-10
---

# Phase 1.1 Plan 03: Dead Code Removal Summary

**Removed 900+ lines of dead code: internal StatusBar from ButtonManager, old ScreenManager class, legacy singletons, extern C helpers, and deprecated static callbacks**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-10T14:17:19Z
- **Completed:** 2026-02-10T14:24:14Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- ButtonManager no longer creates internal StatusBar (eliminated duplicate with persistent StatusBar on lv_layer_top)
- Old ScreenManager class fully removed from jornada_keyboard.h/.cpp (replaced by ScreenManagerImpl)
- All legacy extern C helpers removed (initScreenManager, showNumpadKeyboard, showJornadaKeyboard, toggleKeyboard, numpadInit, buttonManagerInit, etc.)
- JornadaKeyboard and NumpadExample singletons (instance, getInstance) fully removed
- Deprecated static callbacks removed (onActionButtonClick, onDigitClick, onOkClick, onCancelClick)
- Global helper functions removed (showNumpad, hideNumpad, initButtonManager, createDefaultJornadaButtons)
- gridContainer properly positioned for persistent StatusBar at top (y=STATUS_BAR_HEIGHT)

## Task Commits

Each task was committed atomically:

1. **Task 1: Remove internal StatusBar from ButtonManager + remove legacy status methods** - `c34d3b9` (refactor)
2. **Task 2: Remove old ScreenManager class + extern C helpers + legacy dead code** - `d431350` (refactor)

## Files Created/Modified
- `include/button_manager.h` - Removed statusBar members, BtnStatusBarData struct, status methods, legacy helper declarations
- `src/button_manager.cpp` - Removed statusBar creation in createScreen(), status method implementations, legacy helpers, extern C wrappers; repositioned gridContainer
- `include/jornada_keyboard.h` - Removed old ScreenManager class, extern C block, singleton members from JornadaKeyboard
- `src/jornada_keyboard.cpp` - Removed ScreenManager implementation, singleton code, no-args init(), onActionButtonClick, extern C functions, redundant macro redefinitions
- `include/numpad_example.h` - Removed singleton members, deprecated callback declarations, showNumpad/hideNumpad declarations
- `src/numpad_example.cpp` - Removed singleton code, no-args init(), deprecated static callbacks, showNumpad/hideNumpad/numpadInit implementations

## Decisions Made
- Removed BtnStatusBarData struct entirely since its only consumer (updateStatusBar) was removed
- Removed extern C wrappers from button_manager.cpp since they were only used by main_old.cpp.bak (backup file)
- Repositioned gridContainer from y=0 to y=STATUS_BAR_HEIGHT to properly account for persistent StatusBar at top (previously the internal statusBar was at the BOTTOM, so gridContainer was at y=0)
- Updated createPopupOverlay to also start at y=STATUS_BAR_HEIGHT for consistency
- Removed redundant SCREEN_WIDTH/SCREEN_HEIGHT/GRID_AREA_HEIGHT macro redefinitions from jornada_keyboard.cpp (already defined in app_config.h via button_manager.h include)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed hideNumpad() compilation error**
- **Found during:** Task 1 (after removing setStatusMessage from ButtonManager)
- **Issue:** hideNumpad() in numpad_example.cpp called mgr->setStatusMessage() which was just removed
- **Fix:** Removed the setStatusMessage call from hideNumpad() since the entire function is removed in Task 2
- **Files modified:** src/numpad_example.cpp
- **Verification:** Build passes
- **Committed in:** c34d3b9 (Task 1 commit)

**2. [Rule 1 - Bug] Fixed gridContainer and popup overlay position for persistent StatusBar**
- **Found during:** Task 1 (reviewing createScreen layout)
- **Issue:** gridContainer was at y=0 (the old internal statusBar was at the BOTTOM). With persistent StatusBar at TOP, gridContainer would be hidden under it
- **Fix:** Set gridContainer alignment to y=STATUS_BAR_HEIGHT and createPopupOverlay to y=STATUS_BAR_HEIGHT
- **Files modified:** src/button_manager.cpp
- **Verification:** Build passes; layout correct for persistent StatusBar at top
- **Committed in:** c34d3b9 (Task 1 commit)

**3. [Rule 1 - Bug] Removed redundant macro redefinitions causing compiler warnings**
- **Found during:** Task 2 (reviewing build output)
- **Issue:** jornada_keyboard.cpp redefined SCREEN_WIDTH, SCREEN_HEIGHT, STATUS_BAR_HEIGHT, GRID_AREA_HEIGHT already defined in app_config.h
- **Fix:** Removed the local #define redefinitions
- **Files modified:** src/jornada_keyboard.cpp
- **Verification:** Build passes with no macro redefinition warnings
- **Committed in:** d431350 (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (2 bugs, 1 blocking)
**Impact on plan:** All auto-fixes necessary for correctness. No scope creep.

## Issues Encountered
None beyond the deviations documented above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 01.1 (Screen Infrastructure Hardening) is now complete (3/3 plans done)
- All screen code uses per-screen instances, no legacy singletons remain
- Architecture is clean and ready for Phase 02 (BLE Core)
- ButtonManager still has getInstance()/singleton for backward compatibility but domain classes no longer depend on it

## Self-Check: PASSED

- All 6 modified files exist on disk
- Both task commits verified (c34d3b9, d431350)
- All 6 verification greps return zero matches (dead code fully removed)
- Build passes with zero errors

---
*Phase: 01.1-screen-infrastructure-hardening*
*Completed: 2026-02-10*
