---
phase: 01.1-screen-infrastructure-hardening
plan: 01
subsystem: ui
tags: [lvgl, event-handler, destructor, debounce, multi-screen]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: "ButtonManager with screen isolation (user_data pattern), ScreenManager"
provides:
  - "ButtonManager event handlers with safe null-guard (no singleton fallback)"
  - "Per-instance popup debounce via lastPopupClickTime_ member"
  - "Leak-free destructor that safely deletes active LVGL screen"
affects: [01.1-02, 01.1-03, 02-ble-core]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Null user_data guard with ESP_LOGE + early return (no singleton fallback)"
    - "Per-instance debounce members instead of static variables"
    - "Active screen deletion via temporary blank screen swap"

key-files:
  created: []
  modified:
    - include/button_manager.h
    - src/button_manager.cpp

key-decisions:
  - "Replace singleton fallback with ESP_LOGE + return to enforce strict screen isolation"
  - "Use temporary blank screen swap when destroying active screen to avoid LVGL undefined state"

patterns-established:
  - "Event handler null-guard: ESP_LOGE(TAG, 'handlerName: null user_data') + return"
  - "Per-instance debounce: member variable instead of static local"

# Metrics
duration: 2min
completed: 2026-02-10
---

# Phase 01.1 Plan 01: ButtonManager Hardening Summary

**Event handler singleton fallback eliminated, per-instance popup debounce, and safe destructor with active screen deletion**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-10T14:04:18Z
- **Completed:** 2026-02-10T14:06:10Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- buttonEventHandler and popupButtonHandler reject null user_data with ESP_LOGE instead of falling back to getInstance(), preventing cross-screen event routing
- Popup debounce moved from static variable to per-instance lastPopupClickTime_ member, eliminating shared state between multiple ButtonManager instances
- Destructor always deletes LVGL screen object, including when it is the active screen (creates temporary blank screen first)

## Task Commits

Each task was committed atomically:

1. **Task 1: Eliminate singleton fallback in event handlers + add per-instance popup debounce** - `03e0e27` (fix)
2. **Task 2: Fix ButtonManager destructor to safely delete LVGL screen in all cases** - `580cd5f` (fix)

## Files Created/Modified
- `include/button_manager.h` - Added lastPopupClickTime_ per-instance debounce member
- `src/button_manager.cpp` - Fixed event handlers (no singleton fallback), fixed popup debounce (per-instance), fixed destructor (active screen safe deletion)

## Decisions Made
- Replace singleton fallback with ESP_LOGE + return: enforces strict isolation. If user_data is null, it is a programming error that should be logged, not silently recovered via singleton which routes events to the wrong screen.
- Temporary blank screen swap in destructor: LVGL 8.4.0 requires an active screen at all times. Creating a blank screen before deleting the active one avoids leaving disp->act_scr as NULL, which would cause undefined rendering behavior.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- ButtonManager event isolation is hardened, ready for Plan 02 (eliminate domain logic singletons)
- Destructor is safe for multi-screen lifecycle management via ScreenManager
- No blockers for subsequent plans

## Self-Check: PASSED

- FOUND: include/button_manager.h
- FOUND: src/button_manager.cpp
- FOUND: 01.1-01-SUMMARY.md
- FOUND: commit 03e0e27
- FOUND: commit 580cd5f

---
*Phase: 01.1-screen-infrastructure-hardening*
*Completed: 2026-02-10*
