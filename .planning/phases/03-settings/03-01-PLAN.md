---
phase: 03-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/ui/screens/settings_screen.h
  - src/ui/screens/settings_screen.cpp
  - include/interfaces/i_nvs.h
  - include/services/nvs/nvs_manager.h
  - src/services/nvs/nvs_manager.cpp
  - include/config/app_config.h
autonomous: true

must_haves:
  truths:
    - "SettingsScreen renders volume slider (0-21) and brightness slider (0-100%) with current value labels"
    - "SettingsScreen displays firmware version, uptime, and free memory in system info section"
    - "SettingsScreen has a Voltar (back) button that navigates back via ScreenManager"
    - "NvsManager can save and load driver names (up to 3 drivers, 32 bytes each)"
  artifacts:
    - path: "include/ui/screens/settings_screen.h"
      provides: "SettingsScreen IScreen implementation header"
      contains: "class SettingsScreen"
    - path: "src/ui/screens/settings_screen.cpp"
      provides: "SettingsScreen with LVGL sliders, labels, system info, back button"
      min_lines: 120
    - path: "include/interfaces/i_nvs.h"
      provides: "INvsManager extended with driver name methods"
      contains: "saveDriverName"
    - path: "src/services/nvs/nvs_manager.cpp"
      provides: "NvsManager with driver name persistence via nvs_set_str/nvs_get_str"
      contains: "saveDriverName"
  key_links:
    - from: "src/ui/screens/settings_screen.cpp"
      to: "NvsManager"
      via: "NvsManager::getInstance()->saveVolume/saveBrightness in slider callbacks"
      pattern: "NvsManager::getInstance"
    - from: "src/ui/screens/settings_screen.cpp"
      to: "simple_audio_manager"
      via: "setAudioVolume() in volume slider callback"
      pattern: "setAudioVolume"
    - from: "src/ui/screens/settings_screen.cpp"
      to: "esp_bsp"
      via: "bsp_display_brightness_set() in brightness slider callback"
      pattern: "bsp_display_brightness_set"
---

<objective>
Create the SettingsScreen UI with volume and brightness sliders plus system info display, and extend NvsManager with driver name persistence.

Purpose: This plan builds the local-only Settings screen experience. Users can see and adjust volume/brightness sliders with immediate hardware effect and NVS persistence. System info (firmware version, uptime, memory) is displayed. Driver name NVS methods are added for BLE use in Plan 03-02. The bidirectional BLE sync wiring happens in Plan 03-03.

Output: SettingsScreen IScreen implementation, NvsManager driver name methods, NVS key constants.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-foundation/01-04-SUMMARY.md
@.planning/phases/02-ble-core/02-04-SUMMARY.md
@.planning/phases/03-settings/03-RESEARCH.md

@include/interfaces/i_screen.h
@include/interfaces/i_nvs.h
@include/services/nvs/nvs_manager.h
@src/services/nvs/nvs_manager.cpp
@include/ui/screens/jornada_screen.h
@include/config/app_config.h
@src/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: SettingsScreen UI with volume/brightness sliders and system info</name>
  <files>
    include/ui/screens/settings_screen.h
    src/ui/screens/settings_screen.cpp
  </files>
  <action>
Create SettingsScreen implementing IScreen (same pattern as JornadaScreen but WITHOUT ButtonManager -- create LVGL widgets directly on screen_).

**Header (settings_screen.h):**
- Class SettingsScreen : public IScreen
- All IScreen virtual methods: getType (return ScreenType::SETTINGS), create, destroy, isCreated, update, onEnter, onExit, getLvScreen, invalidate
- Public: updateVolumeSlider(uint8_t vol), updateBrightnessSlider(uint8_t brightness) -- for external callers (BLE sync in Plan 03-03) to update slider positions without triggering feedback loop
- Private members: screen_, volumeSlider_, brightnessSlider_, volumeLabel_, brightnessLabel_, fwVersionLabel_, uptimeLabel_, memoryLabel_, backBtn_, created_, updatingFromExternal_ (bool flag for feedback loop prevention)
- Forward declare IScreenManager

**Implementation (settings_screen.cpp):**

Layout (480x320, 40px status bar = 280px available):
- Volume section at y=10 (relative to content area): "Volume" label left-aligned, slider 200px wide centered, value label right (e.g., "15")
- Brightness section at y=70: "Brilho" label left-aligned, slider 200px wide centered, value label right (e.g., "75%")
- Horizontal separator line at y=130
- System info section starting y=145:
  - "Firmware: 1.0.0" (using APP_VERSION_STRING from app_config.h)
  - "Uptime: HH:MM:SS" (using esp_timer_get_time() / 1000000)
  - "Memoria livre: XXX KB" (using heap_caps_get_free_size(MALLOC_CAP_INTERNAL))
- "Voltar" button at bottom-center (y=240 relative to content area)

**create():**
- screen_ = lv_obj_create(NULL); set bg color THEME_BG_PRIMARY
- Create all widgets on screen_ using lv_slider_create, lv_label_create, lv_btn_create
- Volume slider: range 0-AUDIO_VOLUME_MAX (21), width 200px
- Brightness slider: range 0-100, width 200px
- Add LV_EVENT_VALUE_CHANGED callbacks to both sliders with user_data=this (static callback functions, cast in handler -- same pattern as existing screens)
- Back button: lv_btn_create with "Voltar" label, LV_EVENT_CLICKED callback

**Volume slider callback (static function):**
1. Get SettingsScreen* self from lv_event_get_user_data
2. If self->updatingFromExternal_ is true, return (prevent feedback loop per Pitfall 1)
3. Get slider value: lv_slider_get_value()
4. Apply immediately: setAudioVolume(value)
5. Persist: NvsManager::getInstance()->saveVolume(value)
6. Update label text: lv_snprintf(buf, sizeof(buf), "%d", value)
7. (BLE notification will be added in Plan 03-03)

**Brightness slider callback (static function):**
1. Same pattern as volume
2. Apply: bsp_display_brightness_set(value)
3. Persist: NvsManager::getInstance()->saveBrightness(value)
4. Update label: lv_snprintf(buf, sizeof(buf), "%d%%", value)

**Back button callback:**
- Use extern declared screen_go_back() C function from i_screen.h

**onEnter():**
- Read current volume from NvsManager::getInstance()->loadVolume(AUDIO_VOLUME_DEFAULT)
- Read current brightness from NvsManager::getInstance()->loadBrightness(100)
- Set slider values with LV_ANIM_OFF (use updatingFromExternal_ = true around the set to prevent callback firing)
- Update value labels

**update():**
- Update uptime label: esp_timer_get_time() / 1000000 -> format HH:MM:SS
- Update memory label: heap_caps_get_free_size(MALLOC_CAP_INTERNAL) / 1024 -> format "XXX KB"
- Note: update() is called every 5ms by ScreenManager but only refresh labels every 1000ms (use a lastInfoUpdate_ member and check delta)

**updateVolumeSlider(uint8_t vol) / updateBrightnessSlider(uint8_t brightness):**
- Set updatingFromExternal_ = true
- lv_slider_set_value(slider, val, LV_ANIM_OFF)
- Update corresponding label
- Set updatingFromExternal_ = false

**destroy():** lv_obj_del(screen_); screen_ = nullptr; created_ = false; (no domain objects to delete -- simpler than JornadaScreen)

**Includes:** config/app_config.h, interfaces/i_screen.h, services/nvs/nvs_manager.h, simple_audio_manager.h, esp_bsp.h (for bsp_display_brightness_set), esp_timer.h, esp_heap_caps.h, lvgl.h, utils/debug_utils.h

Use LOG_TAG("SETTINGS_SCR") for logging.
  </action>
  <verify>
pio run -- build succeeds with zero errors.
Grep for "class SettingsScreen" in include/ui/screens/settings_screen.h.
Grep for "lv_slider_create" in src/ui/screens/settings_screen.cpp.
Grep for "updateVolumeSlider" in settings_screen.h (public method exists for Plan 03-03).
  </verify>
  <done>
SettingsScreen implements all IScreen methods. Volume slider (0-21) and brightness slider (0-100%) created with value labels. System info labels show firmware version, uptime (HH:MM:SS), free memory (KB). Back button calls screen_go_back(). Slider callbacks apply hardware changes immediately (setAudioVolume / bsp_display_brightness_set) and persist to NVS. updatingFromExternal_ flag prevents feedback loops. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: NVS driver name persistence + app_config constants</name>
  <files>
    include/interfaces/i_nvs.h
    include/services/nvs/nvs_manager.h
    src/services/nvs/nvs_manager.cpp
    include/config/app_config.h
  </files>
  <action>
**app_config.h additions (in NVS section, after existing NVS_JORNADA_VERSION):**
```
#define NVS_KEY_DRIVER_PREFIX   "drv_"
#define NVS_KEY_DRIVER_0        "drv_0"
#define NVS_KEY_DRIVER_1        "drv_1"
#define NVS_KEY_DRIVER_2        "drv_2"
```

**i_nvs.h (INvsManager interface -- add after clearJornadaState):**
Add two new pure virtual methods inside the INvsManager class:
```cpp
virtual bool saveDriverName(uint8_t driverId, const char* name) = 0;
virtual bool loadDriverName(uint8_t driverId, char* name, size_t maxLen) = 0;
```
Also add C compatibility functions after existing C wrappers:
```cpp
bool nvs_manager_save_driver_name(uint8_t driver_id, const char* name);
bool nvs_manager_load_driver_name(uint8_t driver_id, char* name, size_t max_len);
```

**nvs_manager.h (NvsManager class):**
Add override declarations for the two new methods.

**nvs_manager.cpp (NvsManager implementation):**

saveDriverName(uint8_t driverId, const char* name):
- Validate driverId 0-2 (MAX_MOTORISTAS - 1). Return false if out of range.
- Build NVS key: use snprintf to format "drv_%d" with driverId.
- Open NVS handle (settings namespace) with NVS_READWRITE.
- Use nvs_set_str(handle, key, name) -- NOT nvs_set_blob. nvs_set_str handles null-terminated strings correctly.
- nvs_commit() and nvs_close().
- Log on success/failure.
- Return true on success.

loadDriverName(uint8_t driverId, char* name, size_t maxLen):
- Validate driverId 0-2. Return false if out of range.
- Build NVS key same as save.
- Open NVS handle (settings namespace) with NVS_READONLY.
- Use nvs_get_str(handle, key, name, &maxLen) -- first call with name=NULL to get required size is NOT needed since we pass maxLen.
- Actually: nvs_get_str requires a pointer to size. Pass &maxLen which will be updated. If key not found, return false (ESP_ERR_NVS_NOT_FOUND is expected for unset names).
- nvs_close().
- Return true on success.

C wrapper implementations:
```cpp
bool nvs_manager_save_driver_name(uint8_t driver_id, const char* name) {
    return NvsManager::getInstance()->saveDriverName(driver_id, name);
}
bool nvs_manager_load_driver_name(uint8_t driver_id, char* name, size_t max_len) {
    return NvsManager::getInstance()->loadDriverName(driver_id, name, max_len);
}
```

Follow existing NvsManager patterns: mutex protection, error logging with ESP_LOGE/ESP_LOGI, nvs_open_from_partition with NVS_PARTITION_LABEL.
  </action>
  <verify>
pio run -- build succeeds.
Grep for "saveDriverName" in i_nvs.h, nvs_manager.h, nvs_manager.cpp.
Grep for "nvs_set_str" in nvs_manager.cpp (confirms string-based storage, not blob).
Grep for "NVS_KEY_DRIVER" in app_config.h.
  </verify>
  <done>
INvsManager interface extended with saveDriverName/loadDriverName. NvsManager implements both using nvs_set_str/nvs_get_str on dedicated nvs_data partition. NVS key constants (drv_0, drv_1, drv_2) defined in app_config.h. C compatibility wrappers provided. Build passes.
  </done>
</task>

</tasks>

<verification>
- `pio run` succeeds with zero errors
- SettingsScreen header and implementation files exist in expected locations
- INvsManager has 2 new virtual methods (saveDriverName, loadDriverName)
- NvsManager implements both driver name methods
- app_config.h has NVS_KEY_DRIVER_* constants
- No changes to main.cpp or ble_service.cpp in this plan (wiring happens in 03-03)
</verification>

<success_criteria>
- Build passes (pio run exits 0)
- SettingsScreen is a complete IScreen implementation with volume slider, brightness slider, system info, and back button
- NvsManager supports driver name persistence (3 drivers, 32 bytes each)
- All new files follow project conventions (snake_case filenames, Portuguese comments, LOG_TAG, 4-space indent)
- SettingsScreen has public updateVolumeSlider/updateBrightnessSlider for external sync
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings/03-01-SUMMARY.md`
</output>
