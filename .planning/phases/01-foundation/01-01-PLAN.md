---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - partitions.csv
  - sdkconfig.defaults
  - include/lv_conf.h
  - include/config/app_config.h
autonomous: true

must_haves:
  truths:
    - "Device boots successfully with new dual-OTA partition table"
    - "LVGL slider, arc, and meter widgets are available for use"
    - "All NVS, OTA, and BLE constants are centralized in app_config.h"
  artifacts:
    - path: "partitions.csv"
      provides: "Dual OTA partition layout"
      contains: "ota_0"
    - path: "sdkconfig.defaults"
      provides: "OTA bootloader and NVS configuration"
      contains: "CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE"
    - path: "include/lv_conf.h"
      provides: "LVGL widget enablement"
      contains: "LV_USE_SLIDER     1"
    - path: "include/config/app_config.h"
      provides: "Centralized NVS/OTA/BLE constants"
      contains: "NVS_PARTITION_LABEL"
  key_links:
    - from: "partitions.csv"
      to: "sdkconfig.defaults"
      via: "Partition table filename reference"
      pattern: "partitions\\.csv"
    - from: "include/config/app_config.h"
      to: "partitions.csv"
      via: "NVS partition label must match CSV name"
      pattern: "nvs_data"
---

<objective>
Replace the factory-only partition table with a dual-OTA layout, enable LVGL widgets needed by future phases, add OTA/NVS/BLE sdkconfig settings, and centralize new constants in app_config.h.

Purpose: This is the irreversible infrastructure foundation. The new partition table enables OTA (Phase 4), the NVS partition enables persistence (Plan 01-04), and the LVGL widgets enable settings/RPM screens (Phases 3, 5). Must be done first because partition changes require USB reflash.

Output: Updated partitions.csv, sdkconfig.defaults, lv_conf.h, and app_config.h. Firmware compiles successfully.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

@partitions.csv
@sdkconfig.defaults
@include/lv_conf.h
@include/config/app_config.h
@platformio.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace partition table and update sdkconfig for OTA</name>
  <files>partitions.csv, sdkconfig.defaults</files>
  <action>
  Replace the entire contents of `partitions.csv` with the dual-OTA layout from research:

  ```csv
  # Dual OTA partition table for ESP32-S3 16MB Flash
  # Teclado de Jornada Digital v2.0
  # Name,     Type, SubType, Offset,   Size,     Flags
  nvs,        data, nvs,     0x9000,   0x4000,
  otadata,    data, ota,     0xD000,   0x2000,
  phy_init,   data, phy,     0xF000,   0x1000,
  ota_0,      app,  ota_0,   0x10000,  0x300000,
  ota_1,      app,  ota_1,   0x310000, 0x300000,
  spiffs,     data, spiffs,  0x610000, 0x100000,
  nvs_data,   data, nvs,     0x710000, 0x10000,
  ```

  Key details:
  - nvs reduced from 0x5000 to 0x4000 (still above 12KB minimum)
  - otadata added at 0xD000 (8KB, required by OTA bootloader)
  - phy_init added at 0xF000 (4KB, for future BLE RF calibration)
  - app0 (factory) replaced by ota_0 (ota_0 subtype) at same offset 0x10000, same 3MB size
  - ota_1 added at 0x310000 (3MB, mirror of ota_0)
  - spiffs moved to 0x610000 (same 1MB size)
  - nvs_data added at 0x710000 (64KB, dedicated app NVS)
  - Total: 7.125MB of 16MB used (44.5%)

  All app partitions are 64KB-aligned. All data partitions are 4KB-aligned.

  Append to `sdkconfig.defaults` (after the existing I2S section):

  ```
  # ============================================================================
  # OTA Support
  # ============================================================================
  CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE=y
  CONFIG_BOOTLOADER_FACTORY_RESET=n

  # ============================================================================
  # NVS
  # ============================================================================
  CONFIG_NVS_ENCRYPTION=n
  ```

  Update the comment at top of sdkconfig.defaults from "Huge APP (3MB No OTA / 1MB SPIFFS)" to "Dual OTA (3MB x2 + 1MB SPIFFS + 64KB NVS)".
  </action>
  <verify>
  Run `pio run` to confirm firmware compiles with the new partition table. The build output should show the partition table being parsed. No errors about partition overlap or alignment.
  </verify>
  <done>partitions.csv contains 7 partitions (nvs, otadata, phy_init, ota_0, ota_1, spiffs, nvs_data) with correct offsets and sizes. sdkconfig.defaults has OTA rollback enabled. `pio run` compiles without partition errors.</done>
</task>

<task type="auto">
  <name>Task 2: Enable LVGL widgets and add centralized constants</name>
  <files>include/lv_conf.h, include/config/app_config.h</files>
  <action>
  In `include/lv_conf.h`, change three widget defines from 0 to 1:
  - Line 486: `#define LV_USE_ARC        0` -> `#define LV_USE_ARC        1`
  - Line 515: `#define LV_USE_SLIDER     0` -> `#define LV_USE_SLIDER     1`
  - Line 563: `#define LV_USE_METER      0` -> `#define LV_USE_METER      1`

  LV_USE_BAR is already 1 (required by LV_USE_SLIDER). No other changes needed.

  In `include/config/app_config.h`, add three new sections before the `#ifdef __cplusplus` closing brace:

  1. NVS Configuration section:
  ```c
  // ============================================================================
  // CONFIGURACOES DE NVS (Non-Volatile Storage)
  // ============================================================================

  #define NVS_PARTITION_LABEL     "nvs_data"
  #define NVS_NS_SETTINGS         "settings"
  #define NVS_NS_JORNADA          "jornada"
  #define NVS_KEY_VOLUME          "volume"
  #define NVS_KEY_BRIGHTNESS      "brightness"
  #define NVS_JORNADA_VERSION     1
  ```

  2. OTA Configuration section:
  ```c
  // ============================================================================
  // CONFIGURACOES DE OTA
  // ============================================================================

  #define OTA_PARTITION_LABEL_0   "ota_0"
  #define OTA_PARTITION_LABEL_1   "ota_1"
  #define OTA_SELF_TEST_TIMEOUT_S 60
  ```

  3. BLE Configuration section (placeholders for Phase 2):
  ```c
  // ============================================================================
  // CONFIGURACOES DE BLE (placeholders para Phase 2)
  // ============================================================================

  #define BLE_DEVICE_NAME_PREFIX  "GS-Jornada"
  #define BLE_MTU_PREFERRED       256
  #define BLE_TASK_CORE           0
  #define BLE_TASK_PRIORITY       3
  #define BLE_TASK_STACK_SIZE     (8 * 1024)
  ```

  4. Screen Navigation section:
  ```c
  // ============================================================================
  // CONFIGURACOES DE NAVEGACAO DE TELAS
  // ============================================================================

  #define SCREEN_TRANSITION_TIME_MS   250
  #define SCREEN_TRANSITION_DELAY_MS  0
  #define SCREEN_NAV_STACK_MAX        8
  ```

  Place these sections AFTER the existing "MACROS UTILITARIAS" section and BEFORE the `#ifdef __cplusplus` closing brace.
  </action>
  <verify>
  Run `pio run` to confirm firmware compiles cleanly. Grep for `LV_USE_SLIDER` in lv_conf.h to confirm it is 1. Grep for `NVS_PARTITION_LABEL` in app_config.h to confirm constants exist.
  </verify>
  <done>lv_conf.h has LV_USE_ARC=1, LV_USE_SLIDER=1, LV_USE_METER=1. app_config.h has NVS, OTA, BLE, and Screen Navigation constant sections. `pio run` compiles without errors.</done>
</task>

</tasks>

<verification>
1. `pio run` compiles successfully with no errors
2. `grep -c "ota_0" partitions.csv` returns 1
3. `grep -c "nvs_data" partitions.csv` returns 1
4. `grep "LV_USE_SLIDER" include/lv_conf.h` shows value 1
5. `grep "NVS_PARTITION_LABEL" include/config/app_config.h` shows "nvs_data"
6. `grep "CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE" sdkconfig.defaults` shows y
</verification>

<success_criteria>
Firmware compiles with dual-OTA partition table, LVGL slider/arc/meter widgets enabled, and all NVS/OTA/BLE/Screen constants centralized in app_config.h. The project is ready for screen manager implementation (Plan 01-02).
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
