---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - include/ui/screens/jornada_screen.h
  - src/ui/screens/jornada_screen.cpp
  - include/ui/screens/numpad_screen.h
  - src/ui/screens/numpad_screen.cpp
  - src/main.cpp
autonomous: false

must_haves:
  truths:
    - "JornadaScreen displays all 12 journey action buttons in a 4x3 grid with motorist indicators, identical to current ButtonManager behavior"
    - "NumpadScreen displays the numpad keyboard with digit input, timeout, and display label, identical to current NumpadExample behavior"
    - "User can navigate between JornadaScreen and NumpadScreen using the menu button in the StatusBar"
    - "User can go back to the previous screen using the back button in the StatusBar"
    - "All existing callbacks (motorist selection popup, audio feedback, ignition status bar updates) continue working"
    - "Screen transitions are animated (slide left/right)"
  artifacts:
    - path: "include/ui/screens/jornada_screen.h"
      provides: "JornadaScreen class declaration implementing IScreen"
      contains: "class JornadaScreen"
    - path: "src/ui/screens/jornada_screen.cpp"
      provides: "Journey button grid with motorist state management"
      contains: "JornadaScreen::create"
    - path: "include/ui/screens/numpad_screen.h"
      provides: "NumpadScreen class declaration implementing IScreen"
      contains: "class NumpadScreen"
    - path: "src/ui/screens/numpad_screen.cpp"
      provides: "Numpad keyboard with digit input and timeout"
      contains: "NumpadScreen::create"
    - path: "src/main.cpp"
      provides: "Updated boot sequence using ScreenManagerImpl"
      contains: "ScreenManagerImpl"
  key_links:
    - from: "src/ui/screens/jornada_screen.cpp"
      to: "include/interfaces/i_screen.h"
      via: "Implements IScreen interface"
      pattern: "class JornadaScreen.*IScreen"
    - from: "src/ui/screens/numpad_screen.cpp"
      to: "include/interfaces/i_screen.h"
      via: "Implements IScreen interface"
      pattern: "class NumpadScreen.*IScreen"
    - from: "src/main.cpp"
      to: "src/ui/screen_manager.cpp"
      via: "main creates ScreenManagerImpl, registers screens, shows initial screen"
      pattern: "ScreenManagerImpl.*getInstance|registerScreen|showInitialScreen"
    - from: "src/ui/screens/jornada_screen.cpp"
      to: "src/jornada_keyboard.cpp"
      via: "JornadaScreen delegates to JornadaKeyboard for button logic"
      pattern: "JornadaKeyboard"
---

<objective>
Extract the journey keyboard and numpad into IScreen implementations (JornadaScreen, NumpadScreen), integrate them with ScreenManagerImpl, and update main.cpp to use the new navigation framework instead of the old ButtonManager/ScreenManager.

Purpose: This is the critical decomposition step -- the monolithic button_manager.cpp (1205 lines) and the old ScreenManager (that doesn't implement IScreenManager) are replaced by proper screen classes. After this plan, the device has the same functionality as v1.x but running on the new architecture.

Output: JornadaScreen and NumpadScreen registered with ScreenManagerImpl, navigable via StatusBar, all v1.x features working.
</objective>

<execution_context>
@/home/mariostjr/.claude/get-shit-done/workflows/execute-plan.md
@/home/mariostjr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

@include/interfaces/i_screen.h
@include/ui/screen_manager.h
@include/ui/widgets/status_bar.h
@include/button_manager.h
@src/button_manager.cpp
@include/jornada_keyboard.h
@src/jornada_keyboard.cpp
@include/numpad_example.h
@src/numpad_example.cpp
@src/main.cpp
@include/config/app_config.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JornadaScreen and NumpadScreen as IScreen implementations</name>
  <files>include/ui/screens/jornada_screen.h, src/ui/screens/jornada_screen.cpp, include/ui/screens/numpad_screen.h, src/ui/screens/numpad_screen.cpp</files>
  <action>
  **CRITICAL APPROACH:** Do NOT delete or modify button_manager.cpp, jornada_keyboard.cpp, or numpad_example.cpp in this task. These files stay in the project for reference and will be excluded from build later if needed. The new screen classes WRAP the existing logic, they don't replace it inline.

  **JornadaScreen (include/ui/screens/jornada_screen.h + src/ui/screens/jornada_screen.cpp):**

  Create a class `JornadaScreen : public IScreen` that:

  1. `getType()` returns `ScreenType::JORNADA`
  2. `create()`:
     - Creates a new LVGL screen: `screen_ = lv_obj_create(NULL)`
     - Sets background to THEME_BG_PRIMARY
     - Leaves the bottom STATUS_BAR_HEIGHT pixels clear (the StatusBar on lv_layer_top() sits there)
     - Creates a grid container at position (0, 0) with size (DISPLAY_WIDTH, DISPLAY_HEIGHT - STATUS_BAR_HEIGHT)
     - Recreates the 4x3 button grid from the existing `createDefaultJornadaButtons()` logic in button_manager.cpp (lines 1145-1165) and JornadaKeyboard::createKeyboard(). Each button has:
       - Label, icon, color from JornadaKeyboard's getIconForAction/getColorForAction/getLabelForAction
       - Motorist indicators (3 small labels per button)
       - Click callback that delegates to JornadaKeyboard's action processing
     - The JornadaScreen owns a JornadaKeyboard instance (or uses the existing singleton) for all domain logic (motorist state, popup creation, audio feedback)
  3. `onEnter()`: Refreshes all motorist indicators, starts any pulsating animations
  4. `onExit()`: Stops animations, saves any pending state
  5. `destroy()`: Calls `lv_obj_del(screen_)`, sets screen_ to nullptr, created_ to false
  6. `update()`: Updates motorist indicators and timing displays periodically
  7. `isCreated()`: Returns created_
  8. `getLvScreen()`: Returns screen_

  **Key dependency:** JornadaScreen holds a pointer to JornadaKeyboard (existing class) for all business logic. It does NOT duplicate the state machine, popup system, or audio logic. It only owns the LVGL UI objects.

  **Handling the popup system:** The motorist selection popup (showMotoristaSelection in jornada_keyboard.cpp) currently creates popups on `lv_scr_act()`. In the new architecture, JornadaScreen's screen_ IS the active screen when visible, so `lv_scr_act()` still works. But the popup must use the JornadaScreen's screen_ as parent to ensure it appears correctly. Adapt JornadaKeyboard to accept a parent object for popups, or have JornadaScreen create the popup and delegate the callback to JornadaKeyboard.

  **NumpadScreen (include/ui/screens/numpad_screen.h + src/ui/screens/numpad_screen.cpp):**

  Create a class `NumpadScreen : public IScreen` that:

  1. `getType()` returns `ScreenType::NUMPAD`
  2. `create()`:
     - Creates a new LVGL screen: `screen_ = lv_obj_create(NULL)`
     - Sets background to THEME_BG_PRIMARY
     - Creates the numpad layout from existing NumpadExample logic:
       - Display label at top showing current number
       - 4x3 button grid: [1][2][3] / [4][5][6] / [7][8][9] / [*][0][#]
       - Each button with click callback for digit entry
     - Holds a reference to NumpadExample for the input processing logic (digit append, clear, timeout, callback)
  3. `onEnter()`: Clears current number, resets timeout
  4. `onExit()`: Stops timeout timer
  5. `destroy()`, `update()`, `isCreated()`, `getLvScreen()` follow same pattern as JornadaScreen

  **Both screens must:**
  - Wrap ALL LVGL calls in `bsp_display_lock(DISPLAY_LOCK_TIMEOUT)` / `bsp_display_unlock()`
  - Use constants from app_config.h (GRID_COLS, GRID_ROWS, BUTTON_WIDTH, etc.)
  - Use theme colors from app_config.h
  - Include proper ESP_LOG tags for debugging
  - Handle the case where `create()` is called when already created (no-op or destroy first)

  **File structure:**
  - Headers in `include/ui/screens/` (this directory may not exist yet -- create it)
  - Source in `src/ui/screens/` (this directory may not exist yet -- create it)
  </action>
  <verify>
  `pio run` compiles with no errors. Both JornadaScreen and NumpadScreen implement all IScreen methods. Grep for `class JornadaScreen` and `class NumpadScreen` to confirm they exist and inherit from IScreen.
  </verify>
  <done>JornadaScreen and NumpadScreen exist as IScreen implementations. JornadaScreen wraps JornadaKeyboard for domain logic. NumpadScreen wraps NumpadExample for input logic. Both manage their own LVGL screen objects with proper create/destroy lifecycle.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate screens with ScreenManagerImpl and update main.cpp boot sequence</name>
  <files>src/main.cpp</files>
  <action>
  Rewrite the system initialization in main.cpp to use the new ScreenManagerImpl instead of the old ButtonManager/ScreenManager approach.

  **Replace the current system_task initialization block** (lines ~131-160, from `buttonManagerInit()` through the "Sistema Pronto" log) with:

  ```cpp
  // Inicializa subsistema de audio
  initSimpleAudio();

  // Inicializa controle de ignicao (before UI, so initial state is known)
  if (initIgnicaoControl(IGNICAO_DEBOUNCE_ON_S, IGNICAO_DEBOUNCE_OFF_S, true)) {
      bool initialState = getIgnicaoStatus();
      ESP_LOGI(TAG, "Estado inicial da ignicao: %s", initialState ? "ON" : "OFF");
      if (initialState) {
          ignicaoStartTime = time_millis();
          ignicaoLigada = true;
      }
  }

  // Cria e inicializa StatusBar no lv_layer_top()
  static StatusBar statusBar;
  statusBar.create();  // No parent - uses lv_layer_top() internally

  // Cria e inicializa ScreenManager
  auto* screenMgr = ScreenManagerImpl::getInstance();
  screenMgr->init();
  screenMgr->setStatusBar(&statusBar);

  // Cria e registra telas
  static JornadaScreen jornadaScreen;
  static NumpadScreen numpadScreen;
  screenMgr->registerScreen(&jornadaScreen);
  screenMgr->registerScreen(&numpadScreen);

  // Mostra tela inicial (Numpad, sem animacao)
  screenMgr->showInitialScreen(ScreenType::NUMPAD);
  ```

  **Update the main loop** to call `screenMgr->update()` instead of the old ButtonManager status updates. The status bar update logic for ignition timers moves into either:
  - The ScreenManagerImpl::update() which calls StatusBar::update() with current ignition data
  - Or stays in main loop but calls statusBar.update() directly

  Preferred approach: main loop collects ignition data and passes to StatusBar via `statusBar.update(StatusBarData{...})`. The ScreenManager update calls `currentScreen->update()`.

  ```cpp
  // Inside main loop:
  if ((now - lastUpdate) >= 1000) {
      lastUpdate = now;
      bool ignicaoOn = getIgnicaoStatus();
      uint32_t tempoIgnicao = (ignicaoLigada && ignicaoOn) ? (now - ignicaoStartTime) : 0;
      StatusBarData data = { ignicaoOn, tempoIgnicao, 0, nullptr };
      statusBar.update(data);
  }

  // Call screen manager update every tick
  screenMgr->update();

  lv_timer_handler();
  vTaskDelay(pdMS_TO_TICKS(5));
  ```

  **Update includes** at top of main.cpp:
  - Add: `#include "ui/screen_manager.h"`, `#include "ui/screens/jornada_screen.h"`, `#include "ui/screens/numpad_screen.h"`, `#include "ui/widgets/status_bar.h"`
  - Keep: `simple_audio_manager.h`, `simple_splash.h`, `ignicao_control.h`, `lvgl_fs_driver.h`, `esp_bsp.h`
  - Remove (or comment out): `button_manager.h`, `numpad_example.h`, `jornada_keyboard.h` direct includes (they are included transitively via screen headers)

  **Remove the old extern "C" declarations** for `btnManager`, `screenManager`, `buttonManagerInit`, etc. since those are no longer used.

  **Keep the onIgnicaoStatusChange callback** but update it to use StatusBar directly instead of `buttonManagerUpdateStatusBar()`.

  **Keep the onJornadaStateChange callback** -- it may be needed by JornadaScreen's domain logic.
  </action>
  <verify>
  `pio run` compiles with no errors. The build should produce a flashable firmware. Grep main.cpp for `ScreenManagerImpl` to confirm new integration. Grep for `buttonManagerInit` to confirm old init is removed.
  </verify>
  <done>main.cpp uses ScreenManagerImpl for all navigation. StatusBar is created on lv_layer_top(). JornadaScreen and NumpadScreen are registered and the initial screen (NUMPAD) is shown. All old ButtonManager/ScreenManager direct usage is removed from main.cpp. Firmware compiles.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify screen navigation and v1.x feature preservation on hardware</name>
  <files>src/main.cpp</files>
  <action>
  Flash firmware and verify the complete screen navigation system on hardware. What was built: JornadaScreen + NumpadScreen with ScreenManagerImpl and persistent StatusBar. The device should behave identically to v1.x but with animated screen transitions and menu/back navigation buttons in the status bar.

  Verification steps:
  1. Flash firmware: `pio run --target upload`
  2. Open serial monitor: `pio device monitor`
  3. Verify boot: Splash screen appears, then Numpad screen loads
  4. Verify StatusBar: Bottom bar shows ignition indicator, timer labels, and a menu button
  5. Tap the menu button: Screen should slide-animate to JornadaScreen (12 journey action buttons visible)
  6. Verify back button appears in StatusBar on JornadaScreen
  7. Tap back button: Screen should slide-animate back to NumpadScreen
  8. On JornadaScreen: Tap a journey button (e.g., Jornada) -- motorist selection popup should appear
  9. Select a motorist -- audio feedback should play, indicator should update
  10. On NumpadScreen: Tap digits -- display label should show entered digits
  11. Toggle ignition (GPIO18) if possible -- StatusBar indicator should update
  12. Verify no crashes after multiple screen transitions (navigate back and forth 5+ times)

  Resume signal: Type "approved" if everything works, or describe specific issues found.
  </action>
  <verify>User confirms all 12 verification steps pass on hardware.</verify>
  <done>Screen navigation works on hardware: animated transitions, menu/back buttons functional, all v1.x features preserved (jornada buttons, numpad input, audio, ignition monitoring).</done>
</task>

</tasks>

<verification>
1. `pio run` compiles successfully with no errors
2. `grep "ScreenManagerImpl" src/main.cpp` confirms new integration
3. `grep -r "class JornadaScreen" include/` confirms JornadaScreen exists
4. `grep -r "class NumpadScreen" include/` confirms NumpadScreen exists
5. `grep "lv_layer_top" src/ui/widgets/status_bar.cpp` confirms StatusBar on persistent layer
6. `grep "registerScreen" src/main.cpp` confirms screens registered with manager
7. No references to `buttonManagerInit` in main.cpp (old system removed)
</verification>

<success_criteria>
Device boots with new screen navigation: Numpad screen initially shown, menu button navigates to Jornada screen, back button returns. All v1.x button/numpad/popup/audio functionality is preserved. Screen transitions are animated. StatusBar persists across transitions. No memory leaks after repeated navigation.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
